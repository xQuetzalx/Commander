<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commander Arena</title>
  <meta name="theme-color" content="#5b21b6">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    html { scroll-behavior: smooth; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    import React from 'https://esm.sh/react@18';
    import { createRoot } from 'https://esm.sh/react-dom@18/client';
    import { Search, Plus, Trash2, Users, Play, Home, BookOpen, Download, X, Crown, ChevronLeft, Heart, Swords, Skull, MessageCircle, Send, Copy, Sparkles, Loader2 } from 'https://esm.sh/lucide-react@0.263.1';

```
const storage = {
  get: async (k, s) => { const i = localStorage.getItem((s?'s-':'')+k); return i ? {value:i} : null; },
  set: async (k, v, s) => { localStorage.setItem((s?'s-':'')+k, v); return {value:v}; }
};

function App() {
  const [view, setView] = React.useState('home');
  const [decks, setDecks] = React.useState([]);
  const [name, setName] = React.useState('');
  const [importModal, setImportModal] = React.useState(false);
  const [importText, setImportText] = React.useState('');
  const [cards, setCards] = React.useState([]);
  const [searchCard, setSearchCard] = React.useState('');
  const [loading, setLoading] = React.useState(false);
  const [selectedCard, setSelectedCard] = React.useState(null);
  const [game, setGame] = React.useState(null);
  const [chat, setChat] = React.useState(false);
  const [msg, setMsg] = React.useState('');

  React.useEffect(() => {
    storage.get('decks').then(r => r && setDecks(JSON.parse(r.value)));
    storage.get('name').then(r => r && setName(r.value));
  }, []);

  const saveName = (n) => { setName(n); storage.set('name', n); };
  const saveDecks = (d) => { setDecks(d); storage.set('decks', JSON.stringify(d)); };

  const searchCards = async (q) => {
    setLoading(true);
    try {
      const res = await fetch('https://api.scryfall.com/cards/search?q=' + encodeURIComponent(q||'format:commander') + '&order=edhrec');
      const data = await res.json();
      setCards(data.data || []);
    } catch(e) {}
    setLoading(false);
  };

  const importDeck = () => {
    const lines = importText.split('\\n').filter(l => l.trim());
    const c = [];
    let n = 'Mazo ' + new Date().toLocaleDateString();
    let cmd = null;
    for(let l of lines) {
      if(l.match(/^Deck:/i)) { n = l.split(':')[1].trim(); continue; }
      if(l.match(/^Commander:/i)) { cmd = l.split(':')[1].trim(); continue; }
      const m = l.match(/^(\\d+)x?\\s+(.+?)(?:\\s+\\([^)]+\\))?$/);
      if(m) c.push({name: m[2].trim(), qty: parseInt(m[1])});
    }
    if(c.length > 0) {
      saveDecks([...decks, {id: Date.now()+'', name:n, commander:cmd, cards:c, total: c.reduce((s,x)=>s+x.qty,0)}]);
      setImportText('');
      setImportModal(false);
    }
  };

  const startGame = async (deck) => {
    if(!name) { alert('Introduce tu nombre'); return; }
    const gid = 'game-' + Date.now();
    const g = {
      id: gid,
      players: [{id: Date.now()+'', name, life:40, cmdDmg:{}, poison:0, deck, color:'#8b5cf6'}],
      msgs: [], turn: 1
    };
    await storage.set(gid, JSON.stringify(g), true);
    setGame(g);
    setView('game');
  };

  const joinGame = async () => {
    const gid = prompt('ID de partida:');
    if(!gid || !name) return;
    const r = await storage.get(gid, true);
    if(r?.value) {
      const g = JSON.parse(r.value);
      if(!g.players.find(p => p.name === name)) {
        const cols = ['#8b5cf6','#ec4899','#10b981','#f59e0b','#3b82f6','#ef4444'];
        const c = cols.find(x => !g.players.map(p=>p.color).includes(x)) || cols[0];
        g.players.push({id:Date.now()+'', name, life:40, cmdDmg:{}, poison:0, color:c});
        await storage.set(gid, JSON.stringify(g), true);
      }
      setGame(g);
      setView('game');
    }
  };

  const updateGame = async (g) => {
    await storage.set(g.id, JSON.stringify(g), true);
    setGame(g);
  };

  const updateLife = (pid, amt) => {
    updateGame({...game, players: game.players.map(p => p.id===pid ? {...p, life: Math.max(0,p.life+amt)} : p)});
  };

  const updateCmdDmg = (pid, from, amt) => {
    updateGame({...game, players: game.players.map(p => {
      if(p.id===pid) {
        const cur = p.cmdDmg[from] || 0;
        return {...p, cmdDmg: {...p.cmdDmg, [from]: Math.max(0, cur+amt)}};
      }
      return p;
    })});
  };

  const updatePoison = (pid, amt) => {
    updateGame({...game, players: game.players.map(p => p.id===pid ? {...p, poison: Math.max(0,Math.min(10,p.poison+amt))} : p)});
  };

  const sendMsg = () => {
    if(!msg.trim()) return;
    updateGame({...game, msgs: [...game.msgs, {id:Date.now()+'', player:name, text:msg}]});
    setMsg('');
  };

  React.useEffect(() => {
    if(!game) return;
    const t = setInterval(async () => {
      const r = await storage.get(game.id, true);
      if(r?.value) setGame(JSON.parse(r.value));
    }, 3000);
    return () => clearInterval(t);
  }, [game?.id]);

  if(view === 'home') {
    return React.createElement('div', {className: 'min-h-screen bg-gradient-to-br from-slate-950 via-violet-950 to-slate-950'},
      React.createElement('div', {className: 'relative'},
        React.createElement('div', {className: 'backdrop-blur-xl bg-black/40 border-b border-violet-500/20 px-6 py-8'},
          React.createElement('div', {className: 'flex items-center gap-3 mb-2'},
            React.createElement(Crown, {className: 'w-10 h-10 text-amber-400'}),
            React.createElement('h1', {className: 'text-4xl font-bold text-white'}, 'Commander Arena')
          )
        )
      ),
      React.createElement('div', {className: 'px-6 py-8 space-y-6'},
        React.createElement('div', {className: 'bg-white/5 border border-violet-500/20 rounded-2xl p-6'},
          React.createElement('input', {
            type: 'text',
            value: name,
            onChange: e => saveName(e.target.value),
            placeholder: 'Tu nombre...',
            className: 'w-full bg-slate-900/50 border border-violet-500/30 rounded-xl px-4 py-3 text-white placeholder-violet-400/40 focus:outline-none'
          })
        ),
        React.createElement('div', {className: 'grid gap-4'},
          React.createElement('button', {
            onClick: () => {setView('cards'); searchCards('');},
            className: 'bg-gradient-to-r from-pink-600/20 to-purple-600/20 border border-pink-500/30 rounded-2xl p-6 flex items-center justify-between'
          },
            React.createElement('div', {className: 'flex items-center gap-4'},
              React.createElement(Sparkles, {className: 'w-7 h-7 text-pink-300'}),
              React.createElement('div', {className: 'text-left'},
                React.createElement('h3', {className: 'text-xl font-bold text-white'}, 'Explorar Cartas'),
                React.createElement('p', {className: 'text-pink-300/70 text-sm'}, 'Ver cartas de Magic')
              )
            ),
            React.createElement(ChevronLeft, {className: 'w-6 h-6 text-pink-300/50 rotate-180'})
          ),
          React.createElement('button', {
            onClick: () => setView('decks'),
            className: 'bg-gradient-to-r from-violet-600/20 to-fuchsia-600/20 border border-violet-500/30 rounded-2xl p-6 flex items-center justify-between'
          },
            React.createElement('div', {className: 'flex items-center gap-4'},
              React.createElement(BookOpen, {className: 'w-7 h-7 text-violet-300'}),
              React.createElement('div', {className: 'text-left'},
                React.createElement('h3', {className: 'text-xl font-bold text-white'}, 'Mis Mazos'),
                React.createElement('p', {className: 'text-violet-300/70 text-sm'}, decks.length + ' mazos')
              )
            ),
            React.createElement(ChevronLeft, {className: 'w-6 h-6 text-violet-300/50 rotate-180'})
          ),
          React.createElement('button', {
            onClick: joinGame,
            className: 'bg-gradient-to-r from-blue-600/20 to-cyan-600/20 border border-blue-500/30 rounded-2xl p-6 flex items-center justify-between'
          },
            React.createElement('div', {className: 'flex items-center gap-4'},
              React.createElement(Users, {className: 'w-7 h-7 text-blue-300'}),
              React.createElement('div', {className: 'text-left'},
                React.createElement('h3', {className: 'text-xl font-bold text-white'}, 'Unirse a Partida'),
                React.createElement('p', {className: 'text-blue-300/70 text-sm'}, 'Juega online')
              )
            ),
            React.createElement(ChevronLeft, {className: 'w-6 h-6 text-blue-300/50 rotate-180'})
          )
        )
      )
    );
  }

  if(view === 'cards') {
    return React.createElement('div', {className: 'min-h-screen bg-gradient-to-br from-slate-950 via-violet-950 to-slate-950'},
      React.createElement('div', {className: 'sticky top-0 backdrop-blur-xl bg-black/40 border-b border-violet-500/20 px-4 py-4 flex gap-3'},
        React.createElement('button', {onClick: () => setView('home'), className: 'text-violet-300'},
          React.createElement(ChevronLeft, {className: 'w-6 h-6'})
        ),
        React.createElement('input', {
          type: 'text',
          value: searchCard,
          onChange: e => setSearchCard(e.target.value),
          onKeyPress: e => e.key === 'Enter' && searchCards(searchCard),
          placeholder: 'Buscar cartas...',
          className: 'flex-1 bg-slate-900/50 border border-violet-500/30 rounded-xl px-4 py-2 text-white placeholder-violet-400/40 focus:outline-none text-sm'
        })
      ),
      React.createElement('div', {className: 'p-4'},
        loading ?
          React.createElement('div', {className: 'flex justify-center py-12'},
            React.createElement(Loader2, {className: 'w-8 h-8 animate-spin text-violet-400'})
          ) :
          React.createElement('div', {className: 'card-grid'},
            cards.map(c =>
              React.createElement('div', {
                key: c.id,
                onClick: () => setSelectedCard(c),
                className: 'bg-slate-800/30 rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition'
              },
                React.createElement('img', {
                  src: c.image_uris?.normal || c.card_faces?.[0]?.image_uris?.normal,
                  alt: c.name,
                  className: 'w-full'
                })
              )
            )
          )
      ),
      selectedCard && React.createElement('div', {
        onClick: () => setSelectedCard(null),
        className: 'fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50'
      },
        React.createElement('img', {
          src: selectedCard.image_uris?.large || selectedCard.image_uris?.normal,
          className: 'max-w-full max-h-[90vh] rounded-xl',
          onClick: e => e.stopPropagation()
        })
      )
    );
  }

  if(view === 'decks') {
    return React.createElement('div', {className: 'min-h-screen bg-gradient-to-br from-slate-950 via-violet-950 to-slate-950'},
      React.createElement('div', {className: 'sticky top-0 backdrop-blur-xl bg-black/40 border-b border-violet-500/20 px-6 py-4 flex justify-between'},
        React.createElement('div', {className: 'flex gap-3'},
          React.createElement('button', {onClick: () => setView('home'), className: 'text-violet-300'},
            React.createElement(ChevronLeft, {className: 'w-6 h-6'})
          ),
          React.createElement('h2', {className: 'text-2xl font-bold text-white'}, 'Mis Mazos')
        ),
        React.createElement('button', {
          onClick: () => setImportModal(true),
          className: 'bg-violet-600 text-white px-4 py-2 rounded-xl flex gap-2'
        },
          React.createElement(Plus, {className: 'w-5 h-5'}),
          'Importar'
        )
      ),
      React.createElement('div', {className: 'p-6 space-y-4'},
        decks.length === 0 ?
          React.createElement('div', {className: 'text-center py-16'},
            React.createElement('p', {className: 'text-violet-300/70 text-lg'}, 'No tienes mazos'),
            React.createElement('p', {className: 'text-violet-400/50 text-sm mt-2'}, 'Importa desde Moxfield')
          ) :
          decks.map(d =>
            React.createElement('div', {key: d.id, className: 'bg-white/5 border border-violet-500/20 rounded-2xl p-5'},
              React.createElement('h3', {className: 'text-xl font-bold text-white mb-2'}, d.name),
              d.commander && React.createElement('div', {className: 'flex gap-2 mb-2'},
                React.createElement(Crown, {className: 'w-4 h-4 text-amber-400'}),
                React.createElement('span', {className: 'text-violet-300 text-sm'}, d.commander)
              ),
              React.createElement('p', {className: 'text-violet-400/60 text-sm mb-4'}, d.total + ' cartas'),
              React.createElement('button', {
                onClick: () => startGame(d),
                className: 'w-full bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white rounded-xl px-4 py-3 flex items-center justify-center gap-2 font-semibold'
              },
                React.createElement(Play, {className: 'w-5 h-5'}),
                'Iniciar Partida'
              )
            )
          )
      ),
      importModal && React.createElement('div', {className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50'},
        React.createElement('div', {className: 'bg-slate-900 border border-violet-500/30 rounded-2xl max-w-2xl w-full'},
          React.createElement('div', {className: 'px-6 py-5 border-b border-violet-500/20 flex justify-between'},
            React.createElement('h3', {className: 'text-2xl font-bold text-white'}, 'Importar Mazo'),
            React.createElement('button', {onClick: () => setImportModal(false), className: 'text-violet-400'},
              React.createElement(X, {className: 'w-6 h-6'})
            )
          ),
          React.createElement('div', {className: 'p-6'},
            React.createElement('p', {className: 'text-violet-300 text-sm mb-4'}, 'Pega el texto de Moxfield:'),
            React.createElement('textarea', {
              value: importText,
              onChange: e => setImportText(e.target.value),
              placeholder: 'Commander:\\nAtraxa\\n\\n1 Sol Ring\\n1 Command Tower\\n...',
              className: 'w-full h-80 bg-slate-800/50 border border-violet-500/30 rounded-xl px-4 py-3 text-white placeholder-violet-400/40 focus:outline-none resize-none font-mono text-sm'
            })
          ),
          React.createElement('div', {className: 'px-6 py-5 border-t border-violet-500/20 flex gap-3'},
            React.createElement('button', {
              onClick: () => setImportModal(false),
              className: 'flex-1 bg-slate-700 text-white rounded-xl px-4 py-3 font-semibold'
            }, 'Cancelar'),
            React.createElement('button', {
              onClick: importDeck,
              className: 'flex-1 bg-violet-600 text-white rounded-xl px-4 py-3 flex justify-center gap-2 font-semibold'
            },
              React.createElement(Download, {className: 'w-5 h-5'}),
              'Importar'
            )
          )
        )
      )
    );
  }

  if(view === 'game' && game) {
    const me = game.players.find(p => p.name === name);
    return React.createElement('div', {className: 'min-h-screen bg-gradient-to-br from-slate-950 via-violet-950 to-slate-950 pb-20'},
      React.createElement('div', {className: 'sticky top-0 backdrop-blur-xl bg-black/40 border-b border-violet-500/20 px-4 py-3 flex justify-between'},
        React.createElement('div', {className: 'flex gap-3'},
          React.createElement('button', {
            onClick: () => {if(confirm('¿Salir?')) {setView('home'); setGame(null);}},
            className: 'text-violet-300'
          }, React.createElement(ChevronLeft, {className: 'w-6 h-6'})),
          React.createElement('div', null,
            React.createElement('h2', {className: 'font-bold text-white'}, 'Partida'),
            React.createElement('p', {className: 'text-xs text-violet-400'}, 'Turno ' + game.turn)
          )
        ),
        React.createElement('div', {className: 'flex gap-2'},
          React.createElement('button', {
            onClick: () => {navigator.clipboard.writeText(game.id); alert('ID: '+game.id);},
            className: 'p-2 text-violet-400'
          }, React.createElement(Copy, {className: 'w-5 h-5'})),
          React.createElement('button', {
            onClick: () => setChat(!chat),
            className: 'p-2 text-violet-400'
          }, React.createElement(MessageCircle, {className: 'w-5 h-5'}))
        )
      ),
      React.createElement('div', {className: 'p-4 grid md:grid-cols-2 gap-4'},
        game.players.map(p =>
          React.createElement('div', {
            key: p.id,
            className: 'bg-white/5 border rounded-2xl p-5',
            style: {
              borderColor: p.id === me?.id ? p.color : 'rgba(139,92,246,0.2)',
              boxShadow: p.id === me?.id ? '0 0 20px '+p.color+'40' : 'none'
            }
          },
            React.createElement('div', {className: 'flex justify-between mb-4'},
              React.createElement('div', {className: 'flex gap-3'},
                React.createElement('div', {className: 'w-3 h-3 rounded-full', style: {backgroundColor: p.color}}),
                React.createElement('div', null,
                  React.createElement('h3', {className: 'font-bold text-white'}, p.name),
                  p.deck?.commander && React.createElement('p', {className: 'text-xs text-violet-400 flex gap-1'},
                    React.createElement(Crown, {className: 'w-3 h-3 text-amber-400'}),
                    p.deck.commander
                  )
                )
              ),
              p.id === me?.id && React.createElement('span', {className: 'bg-violet-600/30 text-violet-200 text-xs px-3 py-1 rounded-full'}, 'Tú')
            ),
            React.createElement('div', {className: 'mb-4'},
              React.createElement('div', {className: 'flex justify-between mb-3'},
                React.createElement('div', {className: 'flex gap-2'},
                  React.createElement(Heart, {className: 'w-5 h-5 text-red-400'}),
                  React.createElement('span', {className: 'text-sm text-violet-300'}, 'Vida')
                ),
                React.createElement('span', {
                  className: 'text-4xl font-bold',
                  style: {color: p.life>20 ? '#10b981' : p.life>10 ? '#f59e0b' : '#ef4444'}
                }, p.life)
              ),
              p.id === me?.id && React.createElement('div', {className: 'grid grid-cols-4 gap-2'},
                [-10,-1,1,10].map(a =>
                  React.createElement('button', {
                    key: a,
                    onClick: () => updateLife(p.id, a),
                    className: (a<0?'bg-red-500/20 text-red-300':'bg-green-500/20 text-green-300')+' border rounded-lg py-2 text-sm font-semibold'
                  }, a>0?'+'+a:a)
                )
              )
            ),
            game.players.length > 1 && React.createElement('div', {className: 'mb-4'},
              React.createElement('div', {className: 'flex gap-2 mb-2'},
                React.createElement(Swords, {className: 'w-4 h-4 text-orange-400'}),
                React.createElement('span', {className: 'text-xs text-violet-300'}, 'Daño Cmd')
              ),
              React.createElement('div', {className: 'space-y-2'},
                game.players.filter(x => x.id !== p.id).map(o =>
                  React.createElement('div', {key: o.id, className: 'flex justify-between text-sm bg-slate-800/30 rounded-lg px-3 py-2'},
                    React.createElement('span', {className: 'text-violet-400 flex gap-2'},
                      React.createElement('div', {className: 'w-2 h-2 rounded-full', style:{backgroundColor:o.color}}),
                      o.name
                    ),
                    React.createElement('div', {className: 'flex gap-2'},
                      React.createElement('span', {
                        className: 'font-bold',
                        style: {color: (p.cmdDmg[o.id]||0)>=15 ? '#ef4444' : '#a78bfa'}
                      }, p.cmdDmg[o.id] || 0),
                      p.id === me?.id && React.createElement('div', {className: 'flex gap-1'},
                        [1,-1].map(a =>
                          React.createElement('button', {
                            key: a,
                            onClick: () => updateCmdDmg(p.id, o.id, a),
                            className: 'w-7 h-7 bg-orange-500/20 text-orange-300 rounded text-xs font-bold'
                          }, a>0?'+':'-')
                        )
                      )
                    )
                  )
                )
              )
            ),
            React.createElement('div', {className: 'flex justify-between bg-slate-800/30 rounded-lg px-3 py-2'},
              React.createElement('div', {className: 'flex gap-2'},
                React.createElement(Skull, {className: 'w-4 h-4 text-green-400'}),
                React.createElement('span', {className: 'text-sm text-violet-300'}, 'Veneno')
              ),
              React.createElement('div', {className: 'flex gap-2'},
                React.createElement('span', {
                  className: 'text-lg font-bold',
                  style: {color: p.poison>=8?'#ef4444':p.poison>=5?'#f59e0b':'#10b981'}
                }, p.poison),
                p.id === me?.id && React.createElement('div', {className: 'flex gap-1'},
                  [1,-1].map(a =>
                    React.createElement('button', {
                      key: a,
                      onClick: () => updatePoison(p.id, a),
                      className: 'w-7 h-7 bg-green-500/20 text-green-300 rounded text-xs font-bold'
                    }, a>0?'+':'-')
                  )
                )
              )
            )
          )
        )
      ),
      chat && React.createElement('div', {className: 'fixed bottom-20 left-0 right-0 mx-4 md:max-w-2xl md:mx-auto z-30'},
        React.createElement('div', {className: 'bg-slate-900 border border-violet-500/30 rounded-2xl overflow-hidden'},
          React.createElement('div', {className: 'px-4 py-3 bg-violet-500/10 border-b border-violet-500/20 flex justify-between'},
            React.createElement('h3', {className: 'text-white font-semibold'}, 'Chat'),
            React.createElement('button', {onClick: () => setChat(false), className: 'text-violet-400'},
              React.createElement(X, {className: 'w-5 h-5'})
            )
          ),
          React.createElement('div', {className: 'h-64 overflow-y-auto p-4 space-y-3'},
            game.msgs.length === 0 ?
              React.createElement('p', {className: 'text-violet-400/50 text-sm text-center py-8'}, 'Sin mensajes') :
              game.msgs.map(m =>
                React.createElement('div', {
                  key: m.id,
                  className: 'flex flex-col gap-1 '+(m.player===name?'items-end':'items-start')
                },
                  React.createElement('span', {className: 'text-xs text-violet-400'}, m.player),
                  React.createElement('div', {
                    className: 'max-w-[80%] px-4 py-2 rounded-xl '+(m.player===name?'bg-violet-600 text-white':'bg-slate-800 text-violet-200')
                  },
                    React.createElement('p', {className: 'text-sm'}, m.text)
                  )
                )
              )
          ),
          React.createElement('div', {className: 'p-4 bg-slate-800/50 border-t border-violet-500/20 flex gap-2'},
            React.createElement('input', {
              type: 'text',
              value: msg,
              onChange: e => setMsg(e.target.value),
              onKeyPress: e => e.key==='Enter' && sendMsg(),
              placeholder: 'Mensaje...',
              className: 'flex-1 bg-slate-900/50 border border-violet-500/30 rounded-xl px-4 py-2 text-white placeholder-violet-400/40 focus:outline-none text-sm'
            }),
            React.createElement('button', {
              onClick: sendMsg,
              className: 'bg-violet-600 text-white rounded-xl px-4 py-2'
            }, React.createElement(Send, {className: 'w-5 h-5'}))
          )
        )
      )
    );
  }

  return null;
}

createRoot(document.getElementById('root')).render(React.createElement(App));
```

  </script>
</body>
</html>
